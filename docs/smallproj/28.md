# #27 鱼缸

> 原文：<http://inventwithpython.com/bigbookpython/project27.html>

![](img/9d995d63aaead72cad01120081eb8f75.png)

在一个虚拟鱼缸里观看你自己的虚拟鱼，里面有气泡器和海藻植物。每次你运行这个程序，它会用不同的鱼类型和颜色随机生成鱼。休息一下，享受这个软件水族馆的平静安详，或者尝试在一些虚拟鲨鱼中编程来恐吓它的居民！您不能从 IDE 或编辑器中运行该程序。该程序使用`bext`模块，必须从命令提示符或终端运行才能正确显示。关于`bext`模块的更多信息可以在`pypi.org/project/bext`找到。

## 行动中的计划

图 27-1 显示了运行 `fishtank.py` 时的输出。

![f27001](img/9918c79f00328ec7c7185adbe99a3e9c.png)

:鱼缸程序的输出，有几条鱼、海藻和泡泡

## 它是如何工作的

现代图形程序通常通过擦除整个窗口并每秒重绘 30 或 60 次来生成动画。这给了他们每秒 30 或 60 帧(FPS)的帧速率。FPS 越高，动画运动就越流畅。

绘制到终端窗口要慢得多。如果我们擦除整个终端窗口，用`bext`模块重新绘制它的内容，我们通常只能得到大约 3 或 4 FPS。这将导致窗口明显闪烁。

我们可以通过只在终端窗口发生变化的部分绘制字符来加快速度。鱼缸程序的大部分输出是空白空间，所以为了让元素移动，`clearAquarium()`只需要在鱼、海藻和泡泡当前所在的地方画出`' '`个空格字符。这增加了我们的帧速率，减少了闪烁，并使鱼缸动画更加令人愉快。

```py
"""Fish Tank, by Al Sweigart email@protected #  1
A peaceful animation of a fish tank. Press Ctrl-C to stop. #  2
Similar to ASCIIQuarium or @EmojiAquarium, but mine is based on an #  3
older ASCII fish tank program for DOS. #  4
https://robobunny.com/projects/asciiquarium/html/ #  5
https://twitter.com/EmojiAquarium #  6
This code is available at https://nostarch.com/big-book-small-python-programming #  7
Tags: extra-large, artistic, bext""" #  8
 #  9
import random, sys, time #  10
 #  11
try: #  12
   import bext #  13
except ImportError: #  14
   print('This program requires the bext module, which you') #  15
   print('can install by following the instructions at') #  16
   print('https://pypi.org/project/Bext/') #  17
   sys.exit() #  18
 #  19
# Set up the constants: #  20
WIDTH, HEIGHT = bext.size() #  21
# We can't print to the last column on Windows without it adding a #  22
# newline automatically, so reduce the width by one: #  23
WIDTH -= 1 #  24
 #  25
NUM_KELP = 2  # (!) Try changing this to 10. #  26
NUM_FISH = 10  # (!) Try changing this to 2 or 100. #  27
NUM_BUBBLERS = 1  # (!) Try changing this to 0 or 10. #  28
FRAMES_PER_SECOND = 4  # (!) Try changing this number to 1 or 60. #  29
# (!) Try changing the constants to create a fish tank with only kelp, #  30
# or only bubblers. #  31
 #  32
# NOTE: Every string in a fish dictionary should be the same length. #  33
FISH_TYPES = [ #  34
 {'right': ['><>'],          'left': ['<><']}, #  35
 {'right': ['>||>'],         'left': ['<||<']}, #  36
 {'right': ['>))>'],         'left': ['<[[<']}, #  37
 {'right': ['>||o', '>||.'], 'left': ['o||<', '.||<']}, #  38
 {'right': ['>))o', '>)).'], 'left': ['o[[<', '.[[<']}, #  39
 {'right': ['>-==>'],        'left': ['<==-<']}, #  40
 {'right': [r'>\\>'],        'left': ['<//<']}, #  41
 {'right': ['><)))*>'],      'left': ['<*(((><']}, #  42
 {'right': ['}-[[[*>'],      'left': ['<*]]]-{']}, #  43
 {'right': [']-<)))b>'],     'left': ['<d(((>-[']}, #  44
 {'right': ['><XXX*>'],      'left': ['<*XXX><']}, #  45
 {'right': ['_.-._.-^=>', '.-._.-.^=>', #  46
            '-._.-._^=>', '._.-._.^=>'], #  47
  'left':  ['<=^-._.-._', '<=^.-._.-.', #  48
            '<=^_.-._.-', '<=^._.-._.']}, #  49
 ]  # (!) Try adding your own fish to FISH_TYPES. #  50
LONGEST_FISH_LENGTH = 10  # Longest single string in FISH_TYPES. #  51
 #  52
# The x and y positions where a fish runs into the edge of the screen: #  53
LEFT_EDGE = 0 #  54
RIGHT_EDGE = WIDTH - 1 - LONGEST_FISH_LENGTH #  55
TOP_EDGE = 0 #  56
BOTTOM_EDGE = HEIGHT - 2 #  57
 #  58
 #  59
def main(): #  60
   global FISHES, BUBBLERS, BUBBLES, KELPS, STEP #  61
   bext.bg('black') #  62
   bext.clear() #  63
 #  64
   # Generate the global variables: #  65
   FISHES = [] #  66
   for i in range(NUM_FISH): #  67
       FISHES.append(generateFish()) #  68
 #  69
   # NOTE: Bubbles are drawn, but not the bubblers themselves. #  70
   BUBBLERS = [] #  71
   for i in range(NUM_BUBBLERS): #  72
       # Each bubbler starts at a random position. #  73
       BUBBLERS.append(random.randint(LEFT_EDGE, RIGHT_EDGE)) #  74
   BUBBLES = [] #  75
 #  76
   KELPS = [] #  77
   for i in range(NUM_KELP): #  78
       kelpx = random.randint(LEFT_EDGE, RIGHT_EDGE) #  79
       kelp = {'x': kelpx, 'segments': []} #  80
       # Generate each segment of the kelp: #  81
       for i in range(random.randint(6, HEIGHT - 1)): #  82
           kelp['segments'].append(random.choice(['(', ')'])) #  83
       KELPS.append(kelp) #  84
 #  85
   # Run the simulation: #  86
   STEP = 1 #  87
   while True: #  88
       simulateAquarium() #  89
       drawAquarium() #  90
       time.sleep(1 / FRAMES_PER_SECOND) #  91
       clearAquarium() #  92
       STEP += 1 #  93
 #  94
 #  95
def getRandomColor(): #  96
   """Return a string of a random color.""" #  97
   return random.choice(('black', 'red', 'green', 'yellow', 'blue', #  98
                         'purple', 'cyan', 'white')) #  99
 # 100
 # 101
def generateFish(): # 102
    """Return a dictionary that represents a fish.""" # 103
    fishType = random.choice(FISH_TYPES) # 104
 # 105
    # Set up colors for each character in the fish text: # 106
    colorPattern = random.choice(('random', 'head-tail', 'single')) # 107
    fishLength = len(fishType['right'][0]) # 108
    if colorPattern == 'random':  # All parts are randomly colored. # 109
        colors = [] # 110
        for i in range(fishLength): # 111
            colors.append(getRandomColor()) # 112
    if colorPattern == 'single' or colorPattern == 'head-tail': # 113
        colors = [getRandomColor()] * fishLength  # All the same color. # 114
    if colorPattern == 'head-tail':  # Head/tail different from body. # 115
        headTailColor = getRandomColor() # 116
        colors[0] = headTailColor  # Set head color. # 117
        colors[-1] = headTailColor  # Set tail color. # 118
 # 119
    # Set up the rest of fish data structure: # 120
    fish = {'right':            fishType['right'], # 121
            'left':             fishType['left'], # 122
            'colors':           colors, # 123
            'hSpeed':           random.randint(1, 6), # 124
            'vSpeed':           random.randint(5, 15), # 125
            'timeToHDirChange': random.randint(10, 60), # 126
            'timeToVDirChange': random.randint(2, 20), # 127
            'goingRight':       random.choice([True, False]), # 128
            'goingDown':        random.choice([True, False])} # 129
 # 130
    # 'x' is always the leftmost side of the fish body: # 131
    fish['x'] = random.randint(0, WIDTH - 1 - LONGEST_FISH_LENGTH) # 132
    fish['y'] = random.randint(0, HEIGHT - 2) # 133
    return fish # 134
 # 135
 # 136
def simulateAquarium(): # 137
    """Simulate the movements in the aquarium for one step.""" # 138
    global FISHES, BUBBLERS, BUBBLES, KELP, STEP # 139
 # 140
    # Simulate the fish for one step: # 141
    for fish in FISHES: # 142
        # Move the fish horizontally: # 143
        if STEP % fish['hSpeed'] == 0: # 144
            if fish['goingRight']: # 145
                if fish['x'] != RIGHT_EDGE: # 146
                    fish['x'] += 1  # Move the fish right. # 147
                else: # 148
                    fish['goingRight'] = False  # Turn the fish around. # 149
                    fish['colors'].reverse()  # Turn the colors around. # 150
            else: # 151
                if fish['x'] != LEFT_EDGE: # 152
                    fish['x'] -= 1  # Move the fish left. # 153
                else: # 154
                    fish['goingRight'] = True  # Turn the fish around. # 155
                    fish['colors'].reverse()  # Turn the colors around. # 156
 # 157
        # Fish can randomly change their horizontal direction: # 158
        fish['timeToHDirChange'] -= 1 # 159
        if fish['timeToHDirChange'] == 0: # 160
            fish['timeToHDirChange'] = random.randint(10, 60) # 161
            # Turn the fish around: # 162
            fish['goingRight'] = not fish['goingRight'] # 163
 # 164
        # Move the fish vertically: # 165
        if STEP % fish['vSpeed'] == 0: # 166
            if fish['goingDown']: # 167
                if fish['y'] != BOTTOM_EDGE: # 168
                    fish['y'] += 1  # Move the fish down. # 169
                else: # 170
                    fish['goingDown'] = False  # Turn the fish around. # 171
            else: # 172
                if fish['y'] != TOP_EDGE: # 173
                    fish['y'] -= 1  # Move the fish up. # 174
                else: # 175
                    fish['goingDown'] = True  # Turn the fish around. # 176
 # 177
        # Fish can randomly change their vertical direction: # 178
        fish['timeToVDirChange'] -= 1 # 179
        if fish['timeToVDirChange'] == 0: # 180
            fish['timeToVDirChange'] = random.randint(2, 20) # 181
            # Turn the fish around: # 182
            fish['goingDown'] = not fish['goingDown'] # 183
 # 184
    # Generate bubbles from bubblers: # 185
    for bubbler in BUBBLERS: # 186
        # There is a 1 in 5 chance of making a bubble: # 187
        if random.randint(1, 5) == 1: # 188
            BUBBLES.append({'x': bubbler, 'y': HEIGHT - 2}) # 189
 # 190
    # Move the bubbles: # 191
    for bubble in BUBBLES: # 192
        diceRoll = random.randint(1, 6) # 193
        if (diceRoll == 1) and (bubble['x'] != LEFT_EDGE): # 194
            bubble['x'] -= 1  # Bubble goes left. # 195
        elif (diceRoll == 2) and (bubble['x'] != RIGHT_EDGE): # 196
            bubble['x'] += 1  # Bubble goes right. # 197
 # 198
        bubble['y'] -= 1  # The bubble always goes up. # 199
 # 200
    # Iterate over BUBBLES in reverse because I'm deleting from BUBBLES # 201
    # while iterating over it. # 202
    for i in range(len(BUBBLES) - 1, -1, -1): # 203
        if BUBBLES[i]['y'] == TOP_EDGE:  # Delete bubbles that reach the top. # 204
            del BUBBLES[i] # 205
 # 206
    # Simulate the kelp waving for one step: # 207
    for kelp in KELPS: # 208
        for i, kelpSegment in enumerate(kelp['segments']): # 209
            # 1 in 20 chance to change waving: # 210
            if random.randint(1, 20) == 1: # 211
                if kelpSegment == '(': # 212
                    kelp['segments'][i] = ')' # 213
                elif kelpSegment == ')': # 214
                    kelp['segments'][i] = '(' # 215
 # 216
 # 217
def drawAquarium(): # 218
    """Draw the aquarium on the screen.""" # 219
    global FISHES, BUBBLERS, BUBBLES, KELP, STEP # 220
 # 221
    # Draw quit message. # 222
    bext.fg('white') # 223
    bext.goto(0, 0) # 224
    print('Fish Tank, by Al Sweigart    Ctrl-C to quit.', end='') # 225
 # 226
    # Draw the bubbles: # 227
    bext.fg('white') # 228
    for bubble in BUBBLES: # 229
        bext.goto(bubble['x'], bubble['y']) # 230
        print(random.choice(('o', 'O')), end='') # 231
 # 232
    # Draw the fish: # 233
    for fish in FISHES: # 234
        bext.goto(fish['x'], fish['y']) # 235
 # 236
        # Get the correct right- or left-facing fish text. # 237
        if fish['goingRight']: # 238
            fishText = fish['right'][STEP % len(fish['right'])] # 239
        else: # 240
            fishText = fish['left'][STEP % len(fish['left'])] # 241
 # 242
        # Draw each character of the fish text in the right color. # 243
        for i, fishPart in enumerate(fishText): # 244
            bext.fg(fish['colors'][i]) # 245
            print(fishPart, end='') # 246
 # 247
    # Draw the kelp: # 248
    bext.fg('green') # 249
    for kelp in KELPS: # 250
        for i, kelpSegment in enumerate(kelp['segments']): # 251
            if kelpSegment == '(': # 252
                bext.goto(kelp['x'], BOTTOM_EDGE - i) # 253
            elif kelpSegment == ')': # 254
                bext.goto(kelp['x'] + 1, BOTTOM_EDGE - i) # 255
            print(kelpSegment, end='') # 256
 # 257
    # Draw the sand on the bottom: # 258
    bext.fg('yellow') # 259
    bext.goto(0, HEIGHT - 1) # 260
    print(chr(9617) * (WIDTH - 1), end='')  # Draws '░' characters. # 261
 # 262
    sys.stdout.flush()  # (Required for bext-using programs.) # 263
 # 264
 # 265
def clearAquarium(): # 266
    """Draw empty spaces over everything on the screen.""" # 267
    global FISHES, BUBBLERS, BUBBLES, KELP # 268
 # 269
    # Draw the bubbles: # 270
    for bubble in BUBBLES: # 271
        bext.goto(bubble['x'], bubble['y']) # 272
        print(' ', end='') # 273
 # 274
    # Draw the fish: # 275
    for fish in FISHES: # 276
        bext.goto(fish['x'], fish['y']) # 277
 # 278
        # Draw each character of the fish text in the right color. # 279
        print(' ' * len(fish['left'][0]), end='') # 280
 # 281
    # Draw the kelp: # 282
    for kelp in KELPS: # 283
        for i, kelpSegment in enumerate(kelp['segments']): # 284
            bext.goto(kelp['x'], HEIGHT - 2 - i) # 285
            print('  ', end='') # 286
 # 287
    sys.stdout.flush()  # (Required for bext-using programs.) # 288
 # 289
 # 290
# If this program was run (instead of imported), run the game: # 291
if __name__ == '__main__': # 292
    try: # 293
        main() # 294
    except KeyboardInterrupt: # 295
        sys.exit()  # When Ctrl-C is pressed, end the program.  # 296
```

在输入源代码并运行几次之后，尝试对其进行实验性的修改。标有`(!)`的评论对你可以做的小改变有建议。你也可以自己想办法做到以下几点:

*   加上在沙质海底移动的螃蟹。
*   添加一个随机出现在沙底的 ASCII 艺术城堡。
*   让鱼在短时间内随机提高速度。

## 探索计划

试着找出下列问题的答案。尝试对代码进行一些修改，然后重新运行程序，看看这些修改有什么影响。

1.  如果把 51 行的`LONGEST_FISH_LENGTH = 10`改成`LONGEST_FISH_LENGTH = 50`会怎么样？
2.  如果把 121 行的`'right': fishType['right']`改成`'right': fishType['left']`会怎么样？
3.  如果把 249 行的`bext.fg('green')`改成`bext.fg('red')`会怎么样？
4.  如果删除或注释掉第 92 行的`clearAquarium()`会发生什么？
5.  如果把 245 行的`bext.fg(fish['colors'][i])`改成`bext.fg('random')`会怎么样？
6.  如果把 161 行的`random.randint(10, 60)`改成`1`会怎么样？